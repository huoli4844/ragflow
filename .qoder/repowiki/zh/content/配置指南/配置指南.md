# 配置指南

<cite>
**本文档中引用的文件**
- [service_conf.yaml](file://conf/service_conf.yaml)
- [service_conf.yaml.template](file://docker/service_conf.yaml.template)
- [.env](file://docker/.env)
- [settings.py](file://common/settings.py)
- [config_utils.py](file://common/config_utils.py)
- [llm_factories.json](file://conf/llm_factories.json)
- [crypt.py](file://api/utils/crypt.py)
</cite>

## 目录
1. [简介](#简介)
2. [核心配置文件](#核心配置文件)
3. [数据库连接配置](#数据库连接配置)
4. [向量数据库配置](#向量数据库配置)
5. [对象存储配置](#对象存储配置)
6. [缓存配置](#缓存配置)
7. [第三方服务与LLM API密钥配置](#第三方服务与llm-api密钥配置)
8. [环境变量覆盖机制](#环境变量覆盖机制)
9. [不同部署场景的最佳实践](#不同部署场景的最佳实践)
10. [安全配置指南](#安全配置指南)

## 简介

RAGFlow 是一个强大的检索增强生成（RAG）框架，其配置系统设计灵活，支持多种部署场景。本指南旨在系统性地介绍 RAGFlow 的所有可配置选项，帮助用户根据自身需求进行定制化部署。

RAGFlow 的配置主要通过两个核心文件进行管理：`conf/service_conf.yaml` 和 `docker/.env`。前者是主配置文件，定义了服务、数据库、向量库、对象存储等核心组件的连接信息；后者是环境变量文件，用于在 Docker 部署时动态覆盖配置文件中的设置。这种分层配置方式使得 RAGFlow 既能满足开发、测试、生产等不同环境的需求，又能保证配置的安全性和灵活性。

本指南将详细解析 `service_conf.yaml` 文件中的每一个配置项，并解释如何通过 `.env` 文件中的环境变量进行覆盖，同时提供不同场景下的最佳实践和安全建议。

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L1-L153)
- [service_conf.yaml.template](file://docker/service_conf.yaml.template#L1-L154)

## 核心配置文件

RAGFlow 的核心配置文件是 `conf/service_conf.yaml`。该文件采用 YAML 格式，结构清晰，包含了系统运行所需的所有关键配置。其配置项主要分为以下几个部分：

*   **服务配置 (ragflow, admin)**: 定义了 RAGFlow 主服务和管理服务的监听地址和端口。
*   **数据库配置 (mysql, postgres, oceanbase)**: 定义了元数据存储数据库的连接信息。
*   **对象存储配置 (minio, s3, oss, gcs, azure)**: 定义了用于存储原始文档和处理后文件的对象存储服务的连接信息。
*   **向量数据库配置 (es, os, infinity)**: 定义了用于存储和检索向量的向量数据库的连接信息。
*   **缓存配置 (redis)**: 定义了缓存服务的连接信息。
*   **任务队列配置 (task_executor)**: 定义了任务执行器的消息队列类型。
*   **LLM 默认配置 (user_default_llm)**: 定义了默认使用的 LLM 模型及其 API 密钥等信息。
*   **其他服务配置 (oauth, smtp, tcadp_config)**: 定义了第三方认证、邮件服务等可选服务的配置。

配置文件支持通过 `local.service_conf.yaml` 文件进行本地覆盖，该文件会与主配置文件合并，其配置项优先级更高。此外，Docker 部署时，`docker/service_conf.yaml.template` 文件作为模板，其中的 `${VARIABLE_NAME:-default}` 语法会从 `.env` 文件中读取环境变量进行替换。

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L1-L153)
- [service_conf.yaml.template](file://docker/service_conf.yaml.template#L1-L154)

## 数据库连接配置

RAGFlow 使用关系型数据库来存储系统元数据，如用户信息、知识库配置、文档元数据等。`service_conf.yaml` 文件中定义了多种数据库的连接配置。

### MySQL 配置

MySQL 是 RAGFlow 的默认数据库。其配置项如下：

| 配置项 | 含义 | 默认值 | 修改建议 |
| :--- | :--- | :--- | :--- |
| `mysql.name` | 数据库名称 | `rag_flow` | 可根据项目需求修改，确保数据库已创建。 |
| `mysql.user` | 数据库用户名 | `root` | 建议创建专用用户，避免使用 root。 |
| `mysql.password` | 数据库密码 | `infini_rag_flow` | **必须修改**，使用强密码。 |
| `mysql.host` | 数据库主机地址 | `localhost` | 在生产环境中，应指向独立的数据库服务器。 |
| `mysql.port` | 数据库端口 | `5455` | 确保端口未被占用，生产环境建议使用标准端口 3306。 |
| `mysql.max_connections` | 最大连接数 | `900` | 根据预期并发量调整，过高可能导致资源耗尽。 |
| `mysql.stale_timeout` | 连接超时时间（秒） | `300` | 保持默认值通常足够。 |
| `mysql.max_allowed_packet` | 最大允许的数据包大小 | `1073741824` (1GB) | 影响单次传输的数据量，根据文档大小需求调整。 |

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L7-L15)

### PostgreSQL 配置

PostgreSQL 作为可选的数据库后端，其配置与 MySQL 类似，但默认被注释。要启用 PostgreSQL，需取消注释并配置以下项：

| 配置项 | 含义 | 默认值 | 修改建议 |
| :--- | :--- | :--- | :--- |
| `postgres.name` | 数据库名称 | `rag_flow` | 可根据项目需求修改。 |
| `postgres.user` | 数据库用户名 | `rag_flow` | 建议创建专用用户。 |
| `postgres.password` | 数据库密码 | `infini_rag_flow` | **必须修改**，使用强密码。 |
| `postgres.host` | 数据库主机地址 | `postgres` | 在 Docker 环境中，通常为服务名。 |
| `postgres.port` | 数据库端口 | `5432` | PostgreSQL 的标准端口。 |

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L51-L56)

### OceanBase 配置

OceanBase 是一个分布式关系型数据库。其配置通过 `oceanbase` 部分定义：

| 配置项 | 含义 | 默认值 | 修改建议 |
| :--- | :--- | :--- | :--- |
| `oceanbase.scheme` | 连接协议 | `oceanbase` | 保持默认。 |
| `oceanbase.config.db_name` | 文档数据库名称 | `test` | 应修改为实际使用的数据库名。 |
| `oceanbase.config.user` | 数据库用户名 | `root@ragflow` | 格式为 `用户名@租户名`。 |
| `oceanbase.config.password` | 数据库密码 | `infini_rag_flow` | **必须修改**。 |
| `oceanbase.config.host` | 数据库主机地址 | `localhost` | 指向 OceanBase 服务器。 |
| `oceanbase.config.port` | 数据库端口 | `2881` | OceanBase 的标准端口。 |

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L31-L38)

## 向量数据库配置

向量数据库是 RAGFlow 实现语义检索的核心。RAGFlow 支持多种向量数据库，通过 `DOC_ENGINE` 环境变量选择。

### Elasticsearch 配置

Elasticsearch 是默认的向量数据库。其配置如下：

| 配置项 | 含义 | 默认值 | 修改建议 |
| :--- | :--- | :--- | :--- |
| `es.hosts` | Elasticsearch 集群地址 | `http://localhost:1200` | 在生产环境中，应指向集群的协调节点。 |
| `es.username` | 用户名 | `elastic` | 建议创建专用角色和用户。 |
| `es.password` | 密码 | `infini_rag_flow` | **必须修改**，使用强密码。 |

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L20-L23)

### Infinity 配置

Infinity 是一个轻量级的向量数据库。其配置如下：

| 配置项 | 含义 | 默认值 | 修改建议 |
| :--- | :--- | :--- | :--- |
| `infinity.uri` | Infinity 服务地址 | `localhost:23817` | 指向 Infinity 服务的 Thrift 端口。 |
| `infinity.db_name` | 数据库名称 | `default_db` | 通常保持默认。 |

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L28-L30)

### OpenSearch 配置

OpenSearch 是 Elasticsearch 的一个分支。其配置与 Elasticsearch 类似：

| 配置项 | 含义 | 默认值 | 修改建议 |
| :--- | :--- | :--- | :--- |
| `os.hosts` | OpenSearch 集群地址 | `http://localhost:1201` | 指向 OpenSearch 服务。 |
| `os.username` | 用户名 | `admin` | 建议创建专用用户。 |
| `os.password` | 密码 | `infini_rag_flow_OS_01` | **必须修改**，使用强密码。 |

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L24-L27)

## 对象存储配置

RAGFlow 使用对象存储来持久化原始文档和处理后的文件。支持多种对象存储服务。

### MinIO 配置

MinIO 是默认的对象存储，常用于本地或私有云部署。

| 配置项 | 含义 | 默认值 | 修改建议 |
| :--- | :--- | :--- | :--- |
| `minio.user` | 访问密钥（Access Key） | `rag_flow` | 建议创建专用用户。 |
| `minio.password` | 秘密密钥（Secret Key） | `infini_rag_flow` | **必须修改**，使用强密钥。 |
| `minio.host` | MinIO 服务地址 | `localhost:9000` | 指向 MinIO 服务。 |

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L16-L19)

### S3 兼容存储配置

RAGFlow 支持任何 S3 兼容的存储服务（如 AWS S3, 阿里云 OSS, 腾讯云 COS 等）。以阿里云 OSS 为例：

| 配置项 | 含义 | 默认值 | 修改建议 |
| :--- | :--- | :--- | :--- |
| `oss.access_key` | 访问密钥 ID | `access_key` | 使用具有最小权限的子账号密钥。 |
| `oss.secret_key` | 访问密钥 | `secret_key` | **必须修改**。 |
| `oss.endpoint_url` | 服务端点 | `http://oss-cn-hangzhou.aliyuncs.com` | 根据实际区域选择。 |
| `oss.region` | 区域 | `cn-hangzhou` | 与端点匹配。 |
| `oss.bucket` | 存储桶名称 | `bucket_name` | 必须提前创建。 |

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L65-L70)

### Google Cloud Storage (GCS) 配置

| 配置项 | 含义 | 默认值 | 修改建议 |
| :--- | :--- | :--- | :--- |
| `gcs.bucket` | 存储桶名称 | `bridgtl-edm-d-bucket-ragflow` | 必须提前创建。 |

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L63-L64)

## 缓存配置

RAGFlow 使用 Redis 作为缓存，用于加速数据访问和任务队列。

### Redis 配置

| 配置项 | 含义 | 默认值 | 修改建议 |
| :--- | :--- | :--- | :--- |
| `redis.db` | Redis 数据库编号 | `1` | 可根据需要选择不同的数据库。 |
| `redis.username` | 用户名 | `''` (空) | 如果 Redis 启用了 ACL，需配置用户名。 |
| `redis.password` | 密码 | `infini_rag_flow` | **必须修改**，使用强密码。 |
| `redis.host` | Redis 服务地址 | `localhost:6379` | 指向 Redis 服务。 |

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L39-L43)

### 任务队列配置

| 配置项 | 含义 | 默认值 | 修改建议 |
| :--- | :--- | :--- | :--- |
| `task_executor.message_queue_type` | 消息队列类型 | `redis` | 当前仅支持 Redis。 |

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L44-L45)

## 第三方服务与LLM API密钥配置

RAGFlow 支持集成多种第三方服务和 LLM 提供商。

### LLM API 密钥配置

LLM 的配置主要在 `user_default_llm` 部分。`conf/llm_factories.json` 文件定义了所有支持的 LLM 厂商和模型。

| 配置项 | 含义 | 默认值 | 修改建议 |
| :--- | :--- | :--- | :--- |
| `user_default_llm.factory` | 默认 LLM 厂商 | `BAAI` | 可设置为 `OpenAI`, `Tongyi-Qianwen`, `ZHIPU-AI` 等。 |
| `user_default_llm.api_key` | 默认 API 密钥 | `backup` | **必须修改**，填入对应厂商的有效密钥。 |
| `user_default_llm.base_url` | API 基础地址 | `backup_base_url` | 对于自托管或兼容 OpenAI API 的服务，需修改此地址。 |
| `user_default_llm.default_models.embedding_model.api_key` | 嵌入模型 API 密钥 | `xxx` | 如果使用外部嵌入服务，需在此处配置密钥。 |
| `user_default_llm.default_models.embedding_model.base_url` | 嵌入模型基础地址 | `http://localhost:6380` | 指向嵌入服务（如 Text Embeddings Inference）的地址。 |

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L46-L50)
- [llm_factories.json](file://conf/llm_factories.json#L1-L800)

### OAuth 认证配置

RAGFlow 支持通过 OAuth2、OIDC、GitHub 等方式登录。

| 配置项 | 含义 | 默认值 | 修改建议 |
| :--- | :--- | :--- | :--- |
| `oauth.oauth2.client_id` | OAuth2 客户端ID | `your_client_id` | 从 OAuth 提供商处获取。 |
| `oauth.oauth2.client_secret` | OAuth2 客户端密钥 | `your_client_secret` | **必须修改**，妥善保管。 |
| `oauth.github.client_id` | GitHub 客户端ID | `your_client_id` | 从 GitHub OAuth App 获取。 |
| `oauth.github.client_secret` | GitHub 客户端密钥 | `your_client_secret` | **必须修改**。 |

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L104-L127)

### 邮件服务配置

用于发送注册验证、密码重置等邮件。

| 配置项 | 含义 | 默认值 | 修改建议 |
| :--- | :--- | :--- | :--- |
| `smtp.mail_server` | 邮件服务器地址 | `""` | 如 `smtp.gmail.com`。 |
| `smtp.mail_port` | 邮件服务器端口 | `465` | 465 (SSL) 或 587 (TLS)。 |
| `smtp.mail_use_ssl` | 是否使用 SSL | `true` | 根据服务器要求设置。 |
| `smtp.mail_use_tls` | 是否使用 TLS | `false` | 根据服务器要求设置。 |
| `smtp.mail_username` | 发件人用户名 | `""` | 完整邮箱地址。 |
| `smtp.mail_password` | 发件人密码 | `""` | **必须修改**，可以是应用专用密码。 |
| `smtp.mail_default_sender` | 默认发件人 | `["RAGFlow", ""]` | 设置显示名称和邮箱地址。 |

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L138-L148)

## 环境变量覆盖机制

RAGFlow 通过环境变量提供了一种强大的配置覆盖机制，尤其在 Docker 部署中至关重要。环境变量的优先级高于 `service_conf.yaml` 文件中的配置。

### 覆盖原理

在 `common/config_utils.py` 中，`get_base_config` 函数首先尝试从环境变量中获取值，如果不存在，则从配置文件中读取。例如，`get_base_config("mysql.password", "default")` 会先检查 `MYSQL_PASSWORD` 环境变量。

```python
def get_base_config(key, default=None):
    if default is None:
        default = os.environ.get(key.upper())  # 优先从环境变量获取
    return CONFIGS.get(key, default)
```

**Diagram sources**
- [config_utils.py](file://common/config_utils.py#L111-L116)

### .env 文件详解

`docker/.env` 文件是 Docker Compose 部署时加载环境变量的主要来源。关键环境变量包括：

*   **`DOC_ENGINE`**: 指定向量数据库类型 (`elasticsearch`, `infinity`, `opensearch`)。
*   **`DEVICE`**: 指定运行设备 (`cpu`, `gpu`)。
*   **`COMPOSE_PROFILES`**: Docker Compose 配置文件，由 `DOC_ENGINE` 和 `DEVICE` 动态生成。
*   **数据库连接**: `MYSQL_PASSWORD`, `ELASTIC_PASSWORD`, `OPENSEARCH_PASSWORD`, `REDIS_PASSWORD` 等，用于覆盖配置文件中的密码。
*   **服务端口**: `SVR_HTTP_PORT`, `ADMIN_SVR_HTTP_PORT`, `ES_PORT`, `OS_PORT`, `MINIO_PORT` 等，用于映射宿主机端口。
*   **LLM 配置**: `TEI_MODEL`, `TEI_HOST`, `TEI_PORT` 用于配置内置的文本嵌入服务。
*   **功能开关**: `REGISTER_ENABLED` (用户注册开关), `SANDBOX_ENABLED` (沙箱开关)。

**Section sources**
- [.env](file://docker/.env#L1-L245)

## 不同部署场景的最佳实践

### 开发环境

*   **目标**: 快速启动，便于调试。
*   **最佳实践**:
    *   使用默认的 `docker-compose.yml`。
    *   保持 `DOC_ENGINE=elasticsearch` 和 `DEVICE=cpu`。
    *   使用 `.env` 文件中的默认密码，但了解其风险。
    *   开启 `REGISTER_ENABLED=1` 以便快速创建测试账户。
    *   可以启用 `MACOS=1` 来优化 macOS 上的性能。

### 测试环境

*   **目标**: 模拟生产环境，进行功能和性能测试。
*   **最佳实践**:
    *   使用与生产环境相同的 `DOC_ENGINE` 和 `DEVICE`。
    *   在 `.env` 文件中使用与生产环境不同的、但同样安全的密码。
    *   使用独立的数据库和对象存储实例，避免与生产数据混淆。
    *   配置独立的邮件服务用于测试。
    *   关闭不必要的功能，如沙箱（除非测试需要）。

### 生产环境

*   **目标**: 高可用、高性能、高安全。
*   **最佳实践**:
    *   **分离服务**: 将数据库 (MySQL)、向量数据库 (Elasticsearch)、对象存储 (MinIO/S3)、缓存 (Redis) 部署在独立的服务器或云服务上，避免单点故障。
    *   **高可用**: 为关键组件（如数据库、向量库）配置集群。
    *   **资源规划**: 根据预期负载，为每个服务分配足够的 CPU、内存和存储。
    *   **网络隔离**: 使用 VPC 或内部网络，限制服务间的访问。
    *   **备份策略**: 为数据库和对象存储制定定期备份和恢复计划。
    *   **监控告警**: 集成 Prometheus、Grafana 等工具，监控服务状态和性能指标。

**Section sources**
- [.env](file://docker/.env#L1-L245)

## 安全配置指南

安全是生产部署的重中之重。以下是一些关键的安全建议：

### 密码与密钥管理

*   **绝不使用默认密码**: `service_conf.yaml` 中的所有密码（如 `mysql.password`, `redis.password`）都必须修改为强密码。
*   **使用环境变量**: 将敏感信息（尤其是密码和 API 密钥）通过 `.env` 文件中的环境变量注入，而不是硬编码在 `service_conf.yaml` 中。确保 `.env` 文件的权限为 `600`，并加入 `.gitignore`。
*   **最小权限原则**: 为数据库、对象存储等服务创建专用的、权限最小的账号。例如，MinIO 用户应仅对特定存储桶有读写权限。
*   **API 密钥轮换**: 定期轮换 LLM API 密钥，并在密钥泄露时立即撤销。

### 配置文件安全

*   **加密存储**: RAGFlow 提供了 `api/utils/crypt.py` 工具，可以使用 `conf/private.pem` 和 `conf/public.pem` 进行非对称加密。可以将敏感配置加密后存储。
*   **避免明文**: 确保 `service_conf.yaml` 文件不包含任何明文的生产环境密钥。
*   **文件权限**: 确保配置文件的权限设置正确，例如 `service_conf.yaml` 应为 `644`，而包含私钥的文件应为 `600`。

### 网络与访问控制

*   **防火墙**: 使用防火墙严格限制对数据库、向量库、Redis 等服务的访问，只允许来自 RAGFlow 服务的 IP 访问。
*   **HTTPS**: 在生产环境中，通过 Nginx 等反向代理为 RAGFlow 服务启用 HTTPS。
*   **认证与授权**: 启用 `authentication` 配置，确保只有授权用户才能访问系统。

**Section sources**
- [service_conf.yaml](file://conf/service_conf.yaml#L127-L153)
- [crypt.py](file://api/utils/crypt.py#L1-L64)