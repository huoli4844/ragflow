# 核心功能

<cite>
**本文档引用的文件**
- [README.md](file://README.md)
- [ragflow_server.py](file://api/ragflow_server.py)
- [base.py](file://agent/component/base.py)
- [agent_with_tools.py](file://agent/component/agent_with_tools.py)
- [kb_app.py](file://api/apps/kb_app.py)
- [document_app.py](file://api/apps/document_app.py)
- [doc_store_conn.py](file://rag/utils/doc_store_conn.py)
- [task_executor.py](file://rag/svr/task_executor.py)
- [document_service.py](file://api/db/services/document_service.py)
- [tavily.py](file://agent/tools/tavily.py)
- [code_exec.py](file://agent/tools/code_exec.py)
- [search.py](file://rag/nlp/search.py)
</cite>

## 目录
1. [知识库管理](#知识库管理)
2. [文档处理流水线](#文档处理流水线)
3. [Agent工作流引擎](#agent工作流引擎)
4. [RAG查询服务](#rag查询服务)

## 知识库管理

知识库（Knowledgebase）是RAGFlow系统中的核心数据组织单元，用于存储和管理一组相关的文档。系统通过`KnowledgebaseService`类提供对知识库的创建、更新、删除和查询等操作。知识库不仅包含文档的集合，还关联了文档解析器（parser_id）、嵌入模型（embd_id）和检索模型（rerank_id）等配置，这些配置决定了文档的处理和检索方式。

知识库的创建通过`kb_app.py`中的`create`路由实现，该路由接收知识库名称、解析器ID等参数，并在数据库中创建相应的记录。知识库的更新和删除操作也通过类似的API路由实现，确保了对知识库生命周期的完整管理。此外，系统还提供了对知识库内文档的批量操作，如状态变更、运行状态控制等，这些功能通过`document_app.py`中的API提供。

**Section sources**
- [kb_app.py](file://api/apps/kb_app.py#L48-L68)
- [document_app.py](file://api/apps/document_app.py#L51-L84)

## 文档处理流水线

文档处理流水线是RAGFlow中负责将原始文档转换为可检索的向量化索引的关键组件。该流程始于文档上传，通过`document_app.py`中的`upload`路由接收用户上传的文件，并将其存储到MinIO等对象存储服务中。随后，系统会为每个文档创建一个处理任务，该任务由`task_executor.py`中的任务执行器异步处理。

文档处理的核心步骤包括：首先，根据文档类型（如PDF、DOCX等）选择合适的解析器（如`pdf_parser.py`、`docx_parser.py`）进行内容提取；其次，利用`chunk`方法将提取的文本分割成适合检索的片段；最后，使用嵌入模型（embedding model）为每个片段生成向量表示，并将这些向量与原始文本片段一起存储到向量数据库（如Elasticsearch或Infinity）中。整个流程由`task_executor.py`中的`build_chunks`和`embedding`函数协调完成，确保了高效且可扩展的文档处理能力。

**Section sources**
- [document_app.py](file://api/apps/document_app.py#L51-L84)
- [task_executor.py](file://rag/svr/task_executor.py#L226-L443)

## Agent工作流引擎

Agent工作流引擎是RAGFlow中实现复杂任务自动化的核心。它允许用户通过图形化界面或DSL（领域特定语言）定义工作流，这些工作流由一系列可执行的组件（Component）组成，如`Begin`、`LLM`、`Retrieval`、`Switch`等。每个组件都有其特定的功能，例如`LLM`组件用于调用大语言模型，`Retrieval`组件用于从知识库中检索相关信息。

Agent的执行由`agent_with_tools.py`中的`Agent`类驱动。当一个Agent被调用时，它会根据预设的提示词（prompt）和上下文信息，通过`_react_with_tools_streamly_async`方法与工具进行交互。这些工具包括Tavily搜索、代码执行等，它们通过`ToolBase`基类实现，并在运行时被动态加载和调用。Agent能够根据任务的复杂性进行多轮对话和工具调用，直到任务完成或达到最大轮数限制。这种设计使得Agent能够处理需要多步推理和外部工具协作的复杂任务。

**Section sources**
- [agent_with_tools.py](file://agent/component/agent_with_tools.py#L81-L420)
- [base.py](file://agent/component/base.py#L393-L474)

## RAG查询服务

RAG查询服务是RAGFlow对外提供检索增强生成能力的接口。当用户提出一个问题时，系统首先通过`search.py`中的`Dealer`类执行检索操作。该操作结合了关键词匹配（sparse retrieval）和向量相似度匹配（dense retrieval），并通过融合策略（如加权求和）来综合两种检索方式的结果，从而提高检索的准确性和召回率。

检索到的相关文档片段随后被送入大语言模型，作为生成最终答案的上下文。这一过程在`ragflow_server.py`的HTTP服务中被封装，通过REST API暴露给外部应用。此外，系统还支持对检索结果进行重排序（reranking），利用专门的重排序模型进一步优化结果的相关性。整个查询流程高效且灵活，能够适应不同场景下的需求，为用户提供高质量的问答服务。

**Section sources**
- [search.py](file://rag/nlp/search.py#L36-L506)
- [ragflow_server.py](file://api/ragflow_server.py#L158-L161)